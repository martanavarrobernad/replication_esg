#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
PCHIP Interpolation for Specific ESG/ENG/REF Groups.
Ignores EEG channels.
"""

from pathlib import Path
import numpy as np
import pandas as pd
import mne
from scipy.interpolate import PchipInterpolator
import gc
import matplotlib.pyplot as plt

# =============================================================================
# CONFIGURACIÓN Y GRUPOS (TU MONTAJE ESPECÍFICO)
# =============================================================================
SUBJECT_DIR = Path("/home/marta.navarrobernad/Desktop/sub-P02/eeg")
CFG_WIN_CSV = SUBJECT_DIR / "tiempos_artefacto_DETALLADO.csv"

GROUPS = {
    'Axilla': ["ENG_AXILLA", "ENG_AXILLA_REF"],
    'Erb':    ["ENG_ERB", "ENG_ERB_REF"],
    'Ref_AC': ["AC"],
    'Ref_TH6':["TH6"],
    'Spinal': ["Iz", "SC1", "S3", "S4", "S5", "S6", "S7", "S8", "S9", 
               "S11", "S12", "S13", "S14", "S15", "S16", "S17", "S18", "S19", "SC6"]
}

# Creamos una lista plana de todos los canales a limpiar para la función
CHANNELS_TO_CLEAN = [ch for group in GROUPS.values() for ch in group]

N_PAD = 5 

# =============================================================================
# FUNCIONES
# =============================================================================

def interpolate_stim_artifact(raw, onsets_sec, start_ms, end_ms, picks, n_pad=5):
    sf = raw.info["sfreq"]
    data = raw._data 
    
    # Solo procesamos los canales que existen en el archivo y están en nuestra lista
    ch_indices = [raw.ch_names.index(ch) for ch in picks if ch in raw.ch_names]
    
    s0 = int(round(start_ms / 1000 * sf))
    s1 = int(round(end_ms / 1000 * sf))
    
    for ons in onsets_sec:
        idx_stim = int(round(ons * sf))
        i0, i1 = idx_stim + s0, idx_stim + s1
        
        if i0 - n_pad < 0 or i1 + n_pad >= data.shape[1]:
            continue

        x_known = np.concatenate([
            np.arange(i0 - n_pad, i0), 
            np.arange(i1 + 1, i1 + 1 + n_pad)
        ])
        x_interp = np.arange(i0, i1 + 1)

        for ch in ch_indices:
            y_known = data[ch, x_known]
            f = PchipInterpolator(x_known, y_known)
            data[ch, i0:i1 + 1] = f(x_interp)

def plot_verification(t_ms, before, after, run_name):
    plt.ioff()
    fig, ax = plt.subplots(figsize=(10, 5))
    ax.plot(t_ms, before * 1e6, color='gray', alpha=0.4, label='Original (Selected Groups)')
    ax.plot(t_ms, after * 1e6, color='green', lw=1.5, label='Cleaned (Selected Groups PCHIP)')
    ax.set_title(f"Targeted Artifact Removal - {run_name}")
    ax.set_xlabel("Time (ms)")
    ax.set_ylabel("Amplitude (µV)")
    ax.axvline(0, color='black', ls='--', alpha=0.3)
    ax.legend()
    ax.grid(True, alpha=0.2)
    
    out_img = SUBJECT_DIR / f"Verify_TARGETED_Clean_{run_name.replace('.vhdr','')}.png"
    plt.savefig(out_img, dpi=150, bbox_inches='tight')
    plt.close(fig)

# =============================================================================
# MAIN
# =============================================================================

def main():
    if not CFG_WIN_CSV.exists():
        print(f"ERROR: CSV no encontrado: {CFG_WIN_CSV}")
        return

    df_win = pd.read_csv(CFG_WIN_CSV)
    
    for _, row in df_win.iterrows():
        vhdr_path = SUBJECT_DIR / row['run']
        if not vhdr_path.exists(): continue
        
        print(f"\n>>> Interpolando grupos (Axilla, Erb, Refs, Spinal) en: {vhdr_path.name}")
        
        raw = mne.io.read_raw_brainvision(vhdr_path, preload=True, verbose=False)
        
        # Filtramos los canales presentes en este archivo específico
        present_picks = [ch for ch in CHANNELS_TO_CLEAN if ch in raw.ch_names]

        # Eventos
        events, event_id = mne.events_from_annotations(raw, verbose=False)
        stim_codes = [v for k, v in event_id.items() if "Stimulus/S" in k]
        onsets = events[np.isin(events[:, 2], stim_codes)][:, 0] / raw.info["sfreq"]

        # Snapshot ANTES (solo de los canales seleccionados)
        epochs = mne.Epochs(raw, events, event_id=None, tmin=-0.01, tmax=0.02, 
                            picks=present_picks, baseline=None, preload=True, verbose=False)
        before_avg = epochs.average().data.mean(axis=0)
        t_ms = epochs.times * 1000

        # Interpolación dirigida
        print(f"   Limpiando {len(present_picks)} canales clave...")
        interpolate_stim_artifact(raw, onsets, row['start_ms'], row['end_ms'], present_picks, N_PAD)

        # Snapshot DESPUÉS
        epochs_after = mne.Epochs(raw, events, event_id=None, tmin=-0.01, tmax=0.02, 
                                  picks=present_picks, baseline=None, preload=True, verbose=False)
        after_avg = epochs_after.average().data.mean(axis=0)

        plot_verification(t_ms, before_avg, after_avg, vhdr_path.name)
        
        out_name = SUBJECT_DIR / f"{vhdr_path.stem}_NoStimArtifact.fif"
        raw.save(out_name, overwrite=True, verbose=False)
        
        print(f"   [OK] Guardado: {out_name.name}")
        
        del raw, epochs, epochs_after, before_avg, after_avg
        gc.collect()

    print("\n--- Proceso completado: EEG ignorado, ESG/ENG/Refs limpios ---")

if __name__ == "__main__":
    main()
